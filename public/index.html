<!DOCTYPE html>
<html lang="pt-BR">
	<head>
	  <meta charset="UTF-8" />
	  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
	  <title>Downloader de VÃ­deos</title>
	  <link rel="stylesheet" href="style.css" />
	</head>
	<body>
		  <main class="container">
		    <h1>Video Downloader</h1>
		    <button id="toggle-theme">ðŸŒ™ Mudar Tema</button>


		    <div id="input-area" class="input-area">
		      <input id="url" type="text" placeholder="Cole a URL do vÃ­deo aqui..." />
		      <button id="enter">Buscar VÃ­deo</button>
		    </div>

		    <div class="video-options">
		      <label>Formato:</label>
		      <select id="file-format">
			<option value="mp4">MP4</option>
			<option value="mp3">MP3</option>
		      </select>

		      <label>Qualidade:</label>
		      <select id="vid-resolution">
			<option value="1080p">1080p</option>
			<option value="720p">720p</option>
			<option value="480p">480p</option>
		      </select>
		      <select id="aud-resolution" style="display: none;">
			<option value="0">Melhor Qualidade</option>
			<option value="5">MÃ©dia Qualidade</option>
			<option value="10">Pior Qualidade</option>
		      </select>
		    </div>

		    <div id="playlist-warning" class="playlist-warning" style="display:none;">
		    	Buscando playlist...
		    </div>
		    <div id="video-warning" class="video-warning" style="display:none;">
			Buscando vÃ­deo...
		    </div>

		    <img id="thumbnail" style="display:none;">
		    <button style="display:none;" id="download" onclick="downloadVideo(videoLink)">Download</button>
		    </div>
		  </main>
		<script>	
			const thumbnail = document.getElementById("thumbnail");
			let videoLink = "";
			const downloadButt = document.getElementById("download");
			const inputText = document.getElementById("url");
			const inputButton = document.getElementById("enter");	
			
			const playlistWarning = document.getElementById("playlist-warning");
			const videoWarning = document.getElementById("video-warning");
			
			// CONFIGS:
			const formats = document.getElementById("file-format");
			let resolutionChose = "vid-resolution";
			let resolutions = document.getElementById(resolutionChose);

			const themeButton = document.getElementById("toggle-theme");

			// Define o tema padrÃ£o escuro
			document.body.classList.add("dark-mode");

			// Carrega a preferÃªncia do usuÃ¡rio (se existir)
			if (localStorage.getItem("theme") === "light") {
			  document.body.classList.remove("dark-mode");
			  document.body.classList.add("light-mode");
			  themeButton.textContent = "ðŸŒž Modo Escuro";
			}

			// Alterna o tema ao clicar
			themeButton.addEventListener("click", () => {
			  if (document.body.classList.contains("light-mode")) {
			    document.body.classList.remove("light-mode");
			    document.body.classList.add("dark-mode");
			    localStorage.setItem("theme", "dark");
			    themeButton.textContent = "ðŸŒž Modo Claro";
			  } else {
			    document.body.classList.remove("dark-mode");
			    document.body.classList.add("light-mode");
			    localStorage.setItem("theme", "light");
			    themeButton.textContent = "ðŸŒ™ Modo Escuro";
			  }
			});

			
			formats.addEventListener("click", getFormat, false);
			function getFormat() {
				resolutions.style="display:none";

				switch(formats.options[formats.selectedIndex ].value){
					case("mp4"):
						
						resolutions = document.getElementById("vid-resolution");
						break;
					case("mp3"):

						resolutions = document.getElementById("aud-resolution");
						break;
				}

				resolutions.style="display:flex";
			}
			
			function hasIndex(url){
				// const match = url.match(/&list=*/);
				const match = url.match(/&index=(\d+)/);
				console.log(match);
				return match ? parseInt(match[1], 10) : null;
			}

			// temp solution
			function isPlaylist(url){
				const match = url.match(/list=*/);
				return match ? true : false;
			}

			inputButton.addEventListener("click", getVideo, false);
			
			inputButton.addEventListener("click", getVideo, false);

			async function getVideo() {
				try {
					if (!inputText.value.trim()) {
						alert("Por favor, insira uma URL.");
						return;
					}

					const url = inputText.value;
					const format = formats.options[formats.selectedIndex].value;
					const quality = resolutions.options[resolutions.selectedIndex].value;
					const index = hasIndex(url);

					// Display appropriate warning
					if (isPlaylist(url)) {
						playlistWarning.style.display = "flex";
					} else {
						videoWarning.style.display = "flex";
					}

					inputButton.innerHTML = "<img src='./reload.gif'>";
					inputButton.disabled = true;

					const response = await fetch(`${window.location.href}video`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ url, format, quality, index }),
					});

					if (!response.ok) {
						throw new Error(`Erro do servidor: ${response.status}`);
					}

					const blob = await response.blob();

					if (blob.type.includes("application/json")) {
						// Optional: parse the JSON error if server sends one
						const reader = new FileReader();
						reader.onload = () => {
							alert(`Erro do servidor: ${reader.result}`);
						};
						reader.readAsText(blob);
						return;
					}

					const file = window.URL.createObjectURL(blob);
					videoLink = file;
					thumbnail.src = `./download.webp?cacheBust=${Date.now()}`;
					thumbnail.style.display = "block";
					downloadButt.style.display = "flex";

				} catch (error) {
					console.error("Erro ao buscar o vÃ­deo:", error);
					alert("Ocorreu um erro ao buscar o vÃ­deo. Verifique a URL e tente novamente.");
				} finally {
					// Reset the UI regardless of success or failure
					inputButton.disabled = false;
					inputButton.innerHTML = "Buscar vÃ­deo";
					videoWarning.style.display = "none";
					playlistWarning.style.display = "none";
				}
			}


			function downloadVideo(url){
			          const a = document.createElement('a');
		              	  a.href = url;
				  a.download = url.split('/').pop();
				  document.body.appendChild(a);
				  a.click();
				  document.body.removeChild(a);
			}

			getFormat();
		</script>
	</body>	
</html>
